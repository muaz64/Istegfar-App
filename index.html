<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#064420">
    <link rel="apple-touch-icon" href="icon.png">
    <title>ইস্তেগফার - রিমাইন্ডার</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                }).catch(err => console.log("SW Registration Failed", err));
            });
        }
    </script>

    <style>
        :root {
            --primary-dark: #064420;
            --primary-light: #1b5e20;
            --accent-gold: #d4af37;
            --soft-white: #fdfffc;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }

        .app-container {
            background: var(--soft-white);
            width: 100%;
            max-width: 420px;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            background: var(--primary-dark);
            background-image: url('https://www.transparenttextures.com/patterns/islamic-art.png');
            padding: 25px 20px;
            text-align: center;
            color: var(--accent-gold);
            border-bottom: 5px solid var(--accent-gold);
        }

        .header i {
            font-size: 40px;
            margin-bottom: 10px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 1px;
        }

        .header p {
            margin: 8px 0 0;
            font-size: 16px;
            color: #eee;
            font-weight: 500;
            min-height: 1.5em;
        }

        .date-display {
            background: #fff;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            color: var(--primary-dark);
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }

        .prayer-dashboard {
            background: #fff9e6;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }

        .prayer-item {
            text-align: center;
            font-size: 13px;
            color: var(--primary-dark);
        }

        .prayer-item b {
            display: block;
            font-size: 15px;
            color: var(--primary-light);
        }

        .dropdown-section {
            background: #fdfae6;
            border-bottom: 1px solid #ddd;
        }

        .dropdown-header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            color: var(--primary-dark);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 0 15px;
        }

        .dropdown-content.show {
            max-height: 200px;
            padding-bottom: 10px;
        }

        .full-prayer-item {
            background: white;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 11px;
            border: 1px solid #eee;
        }

        .full-prayer-item span {
            display: block;
            font-weight: bold;
            color: var(--primary-light);
        }

        .countdown-bar {
            background: var(--primary-light);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        #installBtn {
            display: none;
            margin: 10px auto;
            background: var(--accent-gold);
            color: var(--primary-dark);
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        .content {
            padding: 20px;
        }

        .card {
            background: white;
            padding: 18px;
            border-radius: 20px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .card-title {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 12px;
            font-size: 15px;
        }

        .card-title i {
            margin-right: 10px;
            color: var(--accent-gold);
        }

        .zikir-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 0;
        }

        .zikir-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--primary-dark);
            border: 8px solid var(--accent-gold);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
            user-select: none;
        }

        .zikir-circle:active {
            transform: scale(0.92);
        }

        .reset-btn {
            margin-top: 15px;
            background: #666;
            width: auto;
            padding: 6px 15px;
            font-size: 12px;
            border-radius: 10px;
            color: white;
            border: none;
            cursor: pointer;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            text-align: center;
            background: #fafafa;
            margin-bottom: 10px;
        }

        .checkbox-container {
            margin: 10px 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            font-size: 14px;
            color: #555;
        }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        button:active {
            transform: scale(0.98);
        }

        .status-badge {
            background: #fff9e6;
            border-left: 4px solid var(--accent-gold);
            padding: 12px;
            border-radius: 10px;
            color: #856404;
            font-size: 13px;
            margin: 15px 0;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 14px;
            z-index: 2000;
            transition: bottom 0.4s;
            box-shadow: var(--shadow);
            white-space: nowrap;
        }

        .toast.show {
            bottom: 30px;
        }

        .footer-credit {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        @media (max-width: 360px) {
            .header h1 {
                font-size: 17px;
            }

            .zikir-circle {
                width: 115px;
                height: 115px;
                font-size: 32px;
            }

            .full-prayer-item {
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="toast" class="toast">লোড হচ্ছে...</div>

    <div class="app-container">
        <div class="header">
            <h1>All praises to <b>ALLAH (SWT)</b></h1>
            <br>
            <i class="fa-solid fa-mosque"></i>
            <h2>ইস্তেগফার রিমাইন্ডার</h2>
            <p id="displayZikr">আসতাগফিরুল্লাহিল আজিম</p>
            <button id="installBtn"><i class="fa-solid fa-download"></i> অ্যাপটি সেভ করুন</button>
        </div>

        <div id="dateSection" class="date-display">লোড হচ্ছে...</div>

        <div class="prayer-dashboard">
            <div class="prayer-item">সেহরি শেষ<b id="sehriDash">--:--</b></div>
            <div class="prayer-item">ইফতার<b id="iftarDash">--:--</b></div>
        </div>

        <div class="dropdown-section">
            <div class="dropdown-header" onclick="togglePrayerTimes()">
                <span>নামাজের সময়সূচী (চট্টগ্রাম)</span>
                <i class="fa-solid fa-chevron-down" id="dropIcon"></i>
            </div>
            <div class="dropdown-content" id="prayerContent">
                <div class="full-prayer-item">ফজর <span id="fajrTime">--:--</span></div>
                <div class="full-prayer-item">জোহর <span id="zuhrTime">--:--</span></div>
                <div class="full-prayer-item">আসর <span id="asrTime">--:--</span></div>
                <div class="full-prayer-item">মাগরিব <span id="maghribTime">--:--</span></div>
                <div class="full-prayer-item">ইশা <span id="ishaTime">--:--</span></div>
            </div>
        </div>

        <div class="countdown-bar" id="countdownText">লোড হচ্ছে...</div>

        <div class="content">
            <div class="card">
                <div class="card-title"><i class="fa-solid fa-fingerprint"></i> তসবিহ কাউন্টার</div>
                <div class="zikir-circle-container">
                    <div class="zikir-circle" id="countNum" onclick="addCount()">0</div>
                    <button class="reset-btn" onclick="resetCount()"><i class="fa-solid fa-rotate-right"></i>
                        রিসেট</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fa-solid fa-clock"></i> প্রতিদিন নির্দিষ্ট সময়</div>
                <input type="time" id="timeInp">
                <button onclick="saveDaily()"><i class="fa-solid fa-bell"></i> সেট করুন</button>
            </div>

            <div class="card">
                <div class="card-title"><i class="fa-solid fa-hourglass-half"></i> কত মিনিট পর পর?</div>
                <input type="number" id="minInp" placeholder="যেমন: ৩০" min="1">
                <div class="checkbox-container">
                    <input type="checkbox" id="soundChk" checked>
                    <label for="soundChk">সাউন্ড বাজবে</label>
                </div>
                <button onclick="saveInterval()"><i class="fa-solid fa-repeat"></i> বিরতি সেট করুন</button>
            </div>

            <div id="statusBox" class="status-badge"></div>

            <div class="footer-btns" style="text-align:center;">
                <button
                    style="color:#d32f2f; background:none; text-decoration:underline; font-size:13px; border:none; cursor:pointer;"
                    onclick="resetAll()">
                    সব মুছে ফেলুন
                </button>
            </div>
            <div class="footer-credit">
                <p>Developed by <b>Muaz</b> & <b>Rasel</b></p>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDI8m_KnE0LZqDq7VNshwFRvsVLWyqtnhk",
            authDomain: "istighfar-reminder.firebaseapp.com",
            projectId: "istighfar-reminder",
            storageBucket: "istighfar-reminder.firebasestorage.app",
            messagingSenderId: "677440645870",
            appId: "1:677440645870:web:4a80d72d3784f9445e61ff"
        };
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        async function initPush() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    // Get the active registration of your sw.js
                    const registration = await navigator.serviceWorker.ready;

                    const token = await messaging.getToken({
                        vapidKey: 'BPhgPTEP-rcN_YIrwjVOhL-t10rXbvBehx4WL_fB2nMp_4UwkrmuFRwAnOUndjQq1zZG7jWgV2TffzaQovFPjfw',
                        serviceWorkerRegistration: registration // This stops the 404 error
                    });

                    if (token) {
                        localStorage.setItem('fcm_token', token);
                        console.log("Token:", token);
                    }
                }
            } catch (err) {
                console.error("Firebase Error:", err);
            }
        }

        let dailyTimer, intervalTimer, deferredPrompt;
        let count = parseInt(localStorage.getItem('ist_count')) || 0;
        document.getElementById('countNum').innerText = count;

        const istighfarList = [
            "আসতাগফিরুল্লাহিল আজীম ওয়া আতুবু ইলাইহি",
            "আসতাগফিরুল্লাহ ওয়া আতুবু ইলাইহি",
            "আসতাগফিরুল্লাহ রাব্বি ওয়া আতুবু ইলাইহি",
            "লা ইলাহা ইল্লা আনতা সুবহানাকা ইন্নি কুনতু মিনাজ জালিমীন",
            "আসতাগফিরুল্লাহিল আজিম"
        ];

        function format12Hour(h, m) {
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hours = h % 12 || 12;
            const minutes = String(m).padStart(2, '0');
            return `${hours}:${minutes} ${ampm}`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function togglePrayerTimes() {
            const content = document.getElementById('prayerContent');
            const icon = document.getElementById('dropIcon');
            content.classList.toggle('show');
            icon.classList.toggle('fa-chevron-up');
            icon.classList.toggle('fa-chevron-down');
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            if (window.matchMedia('(display-mode: standalone)').matches) return;
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'flex';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').style.display = 'none';
                deferredPrompt = null;
            }
        });

        function addCount() {
            count++;
            document.getElementById('countNum').innerText = count;
            localStorage.setItem('ist_count', count);
            if(count % 33 === 0) document.getElementById('displayZikr').innerText = istighfarList[Math.floor(Math.random()*istighfarList.length)];
            if (navigator.vibrate) {
                if (count % 100 === 0) navigator.vibrate([200, 100, 200]);
                else if (count % 33 === 0) navigator.vibrate([150, 50, 150]);
                else navigator.vibrate(50);
            }
        }

        function resetCount() {
            count = 0;
            document.getElementById('countNum').innerText = 0;
            localStorage.setItem('ist_count', 0);
            document.getElementById('displayZikr').innerText = istighfarList[0];
            showToast("কাউন্টার রিসেট হয়েছে");
        }

        function updateDates() {
            const now = new Date();
            const engDate = now.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
            const hijriDay = new Intl.NumberFormat('bn-BD').format(1);
            const hijriMonth = "রমজান";
            const hijriYear = new Intl.NumberFormat('bn-BD', { useGrouping: false }).format(1447);

            document.getElementById('dateSection').innerText = `${engDate} | ${hijriDay} ${hijriMonth}, ${hijriYear} হিজরি`;
        }

        function getChattogramTimes() {
            const prayerTimes = [
                { id: 'fajrTime', name: 'ফজর', h: 5, m: 10 },
                { id: 'zuhrTime', name: 'জোহর', h: 12, m: 8 },
                { id: 'asrTime', name: 'আসর', h: 15, m: 24 },
                { id: 'maghribTime', name: 'মাগরিব', h: 17, m: 50 },
                { id: 'ishaTime', name: 'ইশা', h: 19, m: 5 }
            ];
            const sehriTime = { h: 5, m: 5 };
            const iftarTime = { h: 17, m: 50 };

            document.getElementById('sehriDash').innerText = format12Hour(sehriTime.h, sehriTime.m);
            document.getElementById('iftarDash').innerText = format12Hour(iftarTime.h, iftarTime.m);

            prayerTimes.forEach(p => {
                document.getElementById(p.id).innerText = format12Hour(p.h, p.m);
            });

            const now = new Date();
            let nextEvent = null;
            let minDiff = Infinity;
            const events = [...prayerTimes, { name: 'সেহরি শেষ', h: sehriTime.h, m: sehriTime.m }, { name: 'ইফতার', h: iftarTime.h, m: iftarTime.m }];

            events.forEach(ev => {
                let evDate = new Date();
                evDate.setHours(ev.h, ev.m, 0, 0);
                if (evDate < now) evDate.setDate(evDate.getDate() + 1);
                let diff = evDate - now;
                if (diff < minDiff) { minDiff = diff; nextEvent = { ...ev, date: evDate }; }
            });
            updateCountdown(nextEvent);
        }

        function updateCountdown(ev) {
            if (window.cntInterval) clearInterval(window.cntInterval);
            window.cntInterval = setInterval(() => {
                const now = new Date();
                const diff = ev.date - now;
                if (diff <= 0) { clearInterval(window.cntInterval); getChattogramTimes(); return; }
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('countdownText').innerText = `${ev.name} হতে বাকি: ${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        }

        function saveDaily() {
            const val = document.getElementById('timeInp').value;
            if (!val) return showToast("সময় নির্বাচন করুন");
            localStorage.setItem('ist_daily', val);
            startDaily(val);
            updateUI();
            showToast("প্রতিদিনের সময় সেভ হয়েছে");
        }

        function startDaily(time) {
            if (dailyTimer) clearTimeout(dailyTimer);
            const [h, m] = time.split(':').map(Number);
            const now = new Date();
            let target = new Date();
            target.setHours(h, m, 0, 0);
            if (target <= now) target.setDate(target.getDate() + 1);
            dailyTimer = setTimeout(() => {
                notify("ইস্তেগফার সময়", istighfarList[Math.floor(Math.random() * istighfarList.length)]);
                startDaily(time);
            }, target - now);
        }

        function saveInterval() {
            const val = parseInt(document.getElementById('minInp').value);
            if (!val || val < 1) return showToast("সঠিক মিনিট দিন");
            localStorage.setItem('ist_interval', val);
            startInterval(val);
            updateUI();
            showToast("বিরতি সেভ হয়েছে");
        }

        function startInterval(min) {
            if (intervalTimer) clearInterval(intervalTimer);
            intervalTimer = setInterval(() => {
                notify("জিকির রিমাইন্ডার", istighfarList[Math.floor(Math.random() * istighfarList.length)]);
            }, min * 60 * 1000);
        }

        function updateUI() {
            const d = localStorage.getItem('ist_daily');
            const i = localStorage.getItem('ist_interval');
            const box = document.getElementById('statusBox');
            if (!d && !i) { box.style.display = 'none'; return; }
            box.style.display = 'block';
            let formattedDaily = "";
            if (d) {
                const [h, m] = d.split(':').map(Number);
                formattedDaily = format12Hour(h, m);
            }
            box.innerHTML = `<strong>সক্রিয় রিমাইন্ডার:</strong><br>${d ? '• প্রতিদিন ' + formattedDaily + ' টায়<br>' : ''}${i ? '• প্রতি ' + i + ' মিনিট অন্তর' : ''}`;
        }

        function resetAll() {
            if (confirm("সব রিমাইন্ডার মুছে ফেলতে চান?")) {
                localStorage.clear();
                showToast("সব সেটিংস রিসেট করা হয়েছে");
                setTimeout(() => location.reload(), 1500);
            }
        }

        async function notify(title, msg) {
            if (Notification.permission !== "granted") return;
            const options = {
                body: msg,
                icon: 'icon.png',
                badge: 'icon.png',
                vibrate: [200, 100, 200],
                tag: 'zikir-reminder',
                renotify: true
            };
            if ('serviceWorker' in navigator) {
                const reg = await navigator.serviceWorker.ready;
                // This ensures local reminders also show the professional name
                reg.showNotification("ইস্তেগফার রিমাইন্ডার", options);
            } else {
                new Notification("ইস্তেগফার রিমাইন্ডার", options);
            }
            if (document.getElementById('soundChk')?.checked) {
                new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play().catch(() => { });
            }
        }

        window.onload = async () => {
            initPush();
            const d = localStorage.getItem('ist_daily');
            const i = localStorage.getItem('ist_interval');
            if (d) startDaily(d);
            if (i) startInterval(parseInt(i));
            updateUI();
            updateDates();
            getChattogramTimes();
        };
    </script>
</body>

</html>